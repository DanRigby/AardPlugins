<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Wednesday, November 09, 2022, 8:21 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "HyperlinkMapperNotes" generated by Plugin Wizard -->

<muclient>
<plugin
   name="HyperlinkMapperNotes"
   author="Athlau,fizix"
   id="083caff4f4d4b16f38286a41"
   language="Lua"
   purpose="Shows clickable hyperlinks that can be executed via the mappernotecommand <index> alias."
   save_state="y"
   date_written="2022-11-09 20:15:43"
   requires="5.07"
   version="1.02"
   >
<description trim="y">
<![CDATA[
Shows clickable hyperlinks that can be executed via the mappernotecommand <index> alias.
]]>
</description>

</plugin>

<triggers>
  <trigger
    match="^\{exits}\[ Exits: (?<exits>.*) \]$"
    script="trigger_exits"
    ignore_case="n"
    enabled="y"
    regexp="y"
    sequence="100"
    keep_evaluating="y"
    omit_from_output="y"></trigger>
</triggers>

<aliases>
  <alias
    match="^mappernotecommand (?<index>\d+)$"
    script="alias_mappernotecommand"
    enabled="y"
    regexp="y"
    sequence="100"
    ignore_case="y"
    send_to="12"></alias>
</aliases>

<!--  Script  -->


<script>
<![CDATA[
require "gmcphelper"

help_message = [[
Parses mapper notes for current room and shows clickable for embedded commands.
The commands can also be executed via the mappernotecommand <index> alias.

Just surround any part of mapper note with backticks to make it a command:
`whatever_command_in_this_room;another_cmd`

For ex in room [6348]
Note: key on a mountain goat `qw mountain goat`
When passing by it will allow you to click a link to do "qw mountain goat".
]]

require "serialize"

note_commands = {}

function alias_mappernotecommand(name, line, wildcards)
  note_command = nil
  index = tonumber(wildcards.index)

  if index and index > 0 and index <= #note_commands then
      note_command = note_commands[index]
  end

  if note_command == nil then
      print("Mapper note command not found with index " .. index)
      return
  end
  Execute(note_command)
end

function ShowHyperlinks(note)
  hyperlink_found = false
  note_commands = {}
  command_index = 1
  for match in note:gmatch("`(.-)%`") do
    if hyperlink_found then
      ColourTell("black", "black", " ")
    end
    Hyperlink(match, "[" .. match .. "]", match, "magenta", "black", false)
    note_commands[command_index] = match
    command_index = command_index + 1
    hyperlink_found = true
  end
  if hyperlink_found then
    Note("")
    Note("")
  end
end

function trigger_exits(name, line, wildcards, style)
  local roomid = tonumber(gmcp("room.info.num"))
  local rc, notes, found = CallPlugin("b6eae87ccedd84f510b74714", "room_find_notes", roomid)
  if (rc == error_code.eOK) then
    if found then
      ShowHyperlinks(notes)
    end
  end
end

function OnPluginInstall()
  print("HyperlinkMapperNotes loaded.")
  print(help_message)
end

]]>
</script>

</muclient>
